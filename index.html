<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prep Chef Database Testing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-error { background-color: #ef4444; }
        .status-loading { 
            background: linear-gradient(45deg, #6b7280, #9ca3af);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .console-output {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">🔬 Prep Chef Database Testing</h1>
            <p class="text-gray-600">Debug database connections, RLS policies, and data operations</p>
            
            <!-- Connection Status Bar -->
            <div id="connection-bar" class="mt-4 p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span id="connection-indicator" class="status-indicator status-loading"></span>
                        <span id="connection-text" class="font-medium">Initializing...</span>
                    </div>
                    <div class="text-sm text-gray-500" id="connection-details">
                        Loading database service...
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column -->
            <div class="space-y-6">
                <!-- Environment Check -->
                <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        ⚙️ Environment Check
                    </h2>
                    <div id="env-status" class="space-y-3 mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <span class="status-indicator status-loading"></span>
                            Checking configuration...
                        </div>
                    </div>
                    <button onclick="checkEnvironment()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition-colors text-sm font-medium">
                        🔄 Recheck Environment
                    </button>
                </div>

                <!-- Authentication -->
                <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">🔐 Authentication Testing</h2>
                    
                    <div id="auth-status" class="mb-4">
                        <div class="flex items-center text-sm text-gray-600">
                            <span class="status-indicator status-loading"></span>
                            Checking authentication status...
                        </div>
                    </div>

                    <div id="auth-controls" class="space-y-3">
                        <!-- Sign In Form -->
                        <div id="signin-form" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="signin-email" value="test@prepchef.com" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="signin-password" value="test123456"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="signIn()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm transition-colors font-medium">
                                    Sign In
                                </button>
                                <button onclick="signUp()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition-colors font-medium">
                                    Create Test User
                                </button>
                            </div>
                        </div>

                        <!-- Signed In Controls -->
                        <div id="signout-form" class="hidden">
                            <div class="text-sm text-gray-600 mb-3">
                                ✅ Signed in as: <span id="current-user" class="font-medium text-green-700"></span>
                            </div>
                            <button onclick="signOut()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm transition-colors font-medium">
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>

                <!-- RLS Testing -->
                <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">🛡️ RLS Policy Testing</h2>
                    <div id="rls-results" class="space-y-3 mb-4">
                        <div class="text-sm text-gray-600">Test Row Level Security policies to ensure data access is properly controlled</div>
                    </div>
                    <button onclick="testRLSPolicies()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors text-sm font-medium">
                        🧪 Test RLS Policies
                    </button>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Database Operations -->
                <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">🗄️ Database Operations</h2>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="testDatabaseOperations('prep_lists')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm transition-colors font-medium">
                            📋 Test Prep Lists
                        </button>
                        <button onclick="testDatabaseOperations('events')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm transition-colors font-medium">
                            📅 Test Events
                        </button>
                        <button onclick="testDatabaseOperations('recipes')" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded text-sm transition-colors font-medium">
                            👨‍🍳 Test Recipes
                        </button>
                        <button onclick="testDatabaseOperations('methods')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-sm transition-colors font-medium">
                            🔧 Test Methods
                        </button>
                    </div>
                    
                    <div class="pt-4 border-t border-gray-200">
                        <h3 class="font-medium mb-3">Bulk Operations</h3>
                        <div class="flex gap-2">
                            <button onclick="createTestData()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm transition-colors font-medium">
                                ➕ Create Test Data
                            </button>
                            <button onclick="cleanupTestData()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm transition-colors font-medium">
                                🗑️ Cleanup Test Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Real-time Testing -->
                <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">⚡ Real-time Testing</h2>
                    <div id="realtime-status" class="mb-4 text-sm">
                        <span class="status-indicator status-loading"></span>
                        Real-time features not tested yet
                    </div>
                    <button onclick="testRealtime()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition-colors text-sm font-medium">
                        🔄 Test Real-time Subscriptions
                    </button>
                </div>

                <!-- Performance Testing -->
                <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                    <h2 class="text-xl font-semibold mb-4">📊 Performance Testing</h2>
                    <div id="performance-results" class="mb-4 space-y-2">
                        <div class="text-sm text-gray-600">Run performance tests to check query speed and optimization</div>
                    </div>
                    <button onclick="runPerformanceTests()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded transition-colors text-sm font-medium">
                        🏃‍♂️ Run Performance Tests
                    </button>
                </div>
            </div>
        </div>

        <!-- Console Log -->
        <div class="mt-8">
            <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">📋 Test Console</h2>
                    <div class="flex gap-2">
                        <button onclick="exportLog()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            📄 Export
                        </button>
                        <button onclick="clearConsole()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            Clear
                        </button>
                    </div>
                </div>
                <div id="console-log" class="console-output bg-gray-900 text-green-400 p-4 rounded font-mono text-sm max-h-96 overflow-y-auto">
                    <div class="text-gray-500">[System] Database testing console initialized</div>
                    <div class="text-blue-400">[Info] Building database service...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load database service from built module -->
    <script type="module">
        // Load environment variables and initialize
        const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL || 'https://placeholder.supabase.co';
        const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY || 'placeholder-key';
        
        // Import Supabase directly
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // Create Supabase client
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true,
            }
        });

        // Enhanced DatabaseService with proper error handling
        class DatabaseService {
            static supabase = supabase;
            static currentUser = null;
            static userProfile = null;
            static isInitialized = false;

            static async initialize() {
                if (this.isInitialized) return;
                
                try {
                    // Get current session
                    const { data: { session } } = await this.supabase.auth.getSession();
                    this.currentUser = session?.user || null;
                    
                    // Listen for auth changes
                    this.supabase.auth.onAuthStateChange((event, session) => {
                        this.currentUser = session?.user || null;
                        this.userProfile = null;
                        console.log(`[DatabaseService] Auth state changed: ${event}`);
                        
                        // Update UI
                        if (window.updateAuthStatus) {
                            window.updateAuthStatus(!!session?.user, session?.user?.email);
                        }
                    });
                    
                    this.isInitialized = true;
                    console.log('[DatabaseService] Initialized successfully');
                    
                    // Update UI
                    if (this.currentUser && window.updateAuthStatus) {
                        window.updateAuthStatus(true, this.currentUser.email);
                    }
                    
                } catch (error) {
                    console.error('[DatabaseService] Initialization failed:', error);
                    throw error;
                }
            }

            static async diagnoseConnection() {
                const diagnosis = {
                    configured: false,
                    accessible: false,
                    authenticated: false,
                    tables: [],
                    errors: [],
                    user: null,
                    userProfile: null,
                    rlsStatus: {}
                };

                try {
                    // Check configuration
                    const hasUrl = Boolean(SUPABASE_URL && SUPABASE_URL !== 'https://placeholder.supabase.co');
                    const hasKey = Boolean(SUPABASE_ANON_KEY && SUPABASE_ANON_KEY !== 'placeholder-key');
                    
                    if (!hasUrl) diagnosis.errors.push('VITE_SUPABASE_URL not configured in .env');
                    if (!hasKey) diagnosis.errors.push('VITE_SUPABASE_ANON_KEY not configured in .env');
                    
                    diagnosis.configured = hasUrl && hasKey;

                    if (diagnosis.configured) {
                        // Check authentication
                        const { data: { session }, error: authError } = await this.supabase.auth.getSession();
                        
                        if (authError) {
                            diagnosis.errors.push(`Auth error: ${authError.message}`);
                        } else if (session) {
                            diagnosis.authenticated = true;
                            diagnosis.user = {
                                id: session.user.id,
                                email: session.user.email,
                                role: session.user.role
                            };
                        }

                        // Test table accessibility
                        const tablesToTest = ['prep_lists', 'events', 'recipes', 'methods', 'containers', 'companies'];
                        
                        for (const table of tablesToTest) {
                            try {
                                const { data, error } = await this.supabase
                                    .from(table)
                                    .select('id')
                                    .limit(1);
                                    
                                if (error) {
                                    if (error.code === '42501' || error.message?.includes('RLS')) {
                                        diagnosis.tables.push(`${table} (RLS active)`);
                                        diagnosis.accessible = true;
                                        
                                        // This is expected behavior for RLS
                                        diagnosis.rlsStatus[table] = {
                                            enabled: true,
                                            policies: ['SELECT: Row Level Security active']
                                        };
                                    } else if (error.code === '42P01') {
                                        diagnosis.errors.push(`Table '${table}': Table does not exist - run migrations`);
                                    } else {
                                        diagnosis.errors.push(`Table '${table}': ${error.message}`);
                                    }
                                } else {
                                    diagnosis.tables.push(table);
                                    diagnosis.accessible = true;
                                    diagnosis.rlsStatus[table] = {
                                        enabled: false,
                                        policies: ['No RLS policies active']
                                    };
                                }
                            } catch (e) {
                                diagnosis.errors.push(`Table '${table}': ${e.message}`);
                            }
                        }
                    }
                } catch (error) {
                    diagnosis.errors.push(`Connection diagnosis failed: ${error.message}`);
                }

                return diagnosis;
            }

            static async signUp(email, password, userData = {}) {
                try {
                    const { data, error } = await this.supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                full_name: userData.fullName || null
                            }
                        }
                    });

                    if (error) {
                        return { success: false, error: error.message };
                    }

                    return { success: true, user: data.user };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            static async signIn(email, password) {
                try {
                    const { data, error } = await this.supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) {
                        return { success: false, error: error.message };
                    }

                    this.currentUser = data.user;
                    return { success: true, user: data.user };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            static async signOut() {
                try {
                    const { error } = await this.supabase.auth.signOut();
                    if (error) {
                        return { success: false, error: error.message };
                    }
                    
                    this.currentUser = null;
                    this.userProfile = null;
                    return { success: true };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            static async testRLSPolicies() {
                const result = {
                    authenticated: !!this.currentUser,
                    tables: {}
                };

                const tablesToTest = ['prep_lists', 'events', 'recipes', 'methods', 'containers'];
                
                for (const table of tablesToTest) {
                    result.tables[table] = {
                        canRead: false,
                        canInsert: false,
                        canUpdate: false,
                        canDelete: false,
                        errors: []
                    };

                    // Test READ
                    try {
                        const { data, error } = await this.supabase.from(table).select('id').limit(1);
                        if (!error) {
                            result.tables[table].canRead = true;
                        } else {
                            result.tables[table].errors.push(`Read: ${error.message}`);
                        }
                    } catch (error) {
                        result.tables[table].errors.push(`Read: ${error.message}`);
                    }

                    // Only test write operations if authenticated
                    if (this.currentUser) {
                        const testId = `rls-test-${Date.now()}`;
                        
                        // Test INSERT
                        try {
                            let testData = { id: testId, name: 'RLS Test Item' };
                            
                            // Add table-specific required fields
                            switch (table) {
                                case 'events':
                                    testData = { ...testData, event_date: new Date().toISOString().split('T')[0], status: 'pending', total_servings: 0 };
                                    break;
                                case 'recipes':
                                    testData = { ...testData, ingredients: [], instructions: '' };
                                    break;
                                case 'methods':
                                    testData = { ...testData, description: 'Test method' };
                                    break;
                                case 'containers':
                                    testData = { ...testData, description: 'Test container' };
                                    break;
                                case 'prep_lists':
                                    testData = { ...testData, items: [] };
                                    break;
                            }

                            const { error: insertError } = await this.supabase.from(table).insert(testData);
                            if (!insertError) {
                                result.tables[table].canInsert = true;

                                // Test UPDATE
                                try {
                                    const { error: updateError } = await this.supabase
                                        .from(table)
                                        .update({ name: 'RLS Test Updated' })
                                        .eq('id', testId);
                                    if (!updateError) result.tables[table].canUpdate = true;
                                } catch (error) {
                                    result.tables[table].errors.push(`Update: ${error.message}`);
                                }

                                // Test DELETE (cleanup)
                                try {
                                    const { error: deleteError } = await this.supabase
                                        .from(table)
                                        .delete()
                                        .eq('id', testId);
                                    if (!deleteError) result.tables[table].canDelete = true;
                                } catch (error) {
                                    result.tables[table].errors.push(`Delete: ${error.message}`);
                                }
                            } else {
                                result.tables[table].errors.push(`Insert: ${insertError.message}`);
                            }
                        } catch (error) {
                            result.tables[table].errors.push(`Insert: ${error.message}`);
                        }
                    } else {
                        result.tables[table].errors.push('Authentication required for write operations');
                    }
                }

                return result;
            }

            static async createTestData() {
                if (!this.currentUser) {
                    throw new Error('Authentication required to create test data');
                }

                const timestamp = Date.now();
                
                // Create test prep list
                const { error: prepListError } = await this.supabase
                    .from('prep_lists')
                    .insert({
                        id: `test-prep-${timestamp}`,
                        name: `Test Prep List ${new Date().toLocaleTimeString()}`,
                        items: [{ id: '1', name: 'Test Item', quantity: '5', unit: 'lbs' }]
                    });

                if (prepListError) throw prepListError;

                // Create test event
                const { error: eventError } = await this.supabase
                    .from('events')
                    .insert({
                        id: `test-event-${timestamp}`,
                        title: `Test Event ${new Date().toLocaleTimeString()}`,
                        event_date: new Date().toISOString().split('T')[0],
                        status: 'pending',
                        total_servings: 50
                    });

                if (eventError) throw eventError;

                return { success: true };
            }

            static async cleanupTestData() {
                if (!this.currentUser) {
                    throw new Error('Authentication required to cleanup test data');
                }

                const tablesToClean = ['prep_lists', 'events', 'recipes', 'methods', 'containers'];
                let totalDeleted = 0;

                for (const table of tablesToClean) {
                    try {
                        const { data: testItems } = await this.supabase
                            .from(table)
                            .select('id, name')
                            .ilike('name', 'Test %');

                        if (testItems && testItems.length > 0) {
                            const ids = testItems.map(item => item.id);
                            const { error } = await this.supabase
                                .from(table)
                                .delete()
                                .in('id', ids);

                            if (!error) {
                                totalDeleted += testItems.length;
                            }
                        }
                    } catch (error) {
                        console.warn(`Failed to cleanup ${table}:`, error);
                    }
                }

                return { success: true, deleted: totalDeleted };
            }
        }

        // Make DatabaseService globally available
        window.DatabaseService = DatabaseService;

        // Global state
        let currentUser = null;
        let connectionStatus = 'checking';

        // Logging utility
        function log(message, type = 'info') {
            const consoleEl = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: 'text-green-400',
                error: 'text-red-400',
                info: 'text-blue-400',
                warning: 'text-yellow-400',
                system: 'text-gray-400'
            };
            
            const div = document.createElement('div');
            div.className = colors[type] || 'text-gray-300';
            div.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function updateConnectionStatus(status, details = '') {
            const indicator = document.getElementById('connection-indicator');
            const text = document.getElementById('connection-text');
            const detailsEl = document.getElementById('connection-details');
            
            connectionStatus = status;
            
            indicator.className = 'status-indicator ' + {
                'connected': 'status-success',
                'error': 'status-error',
                'warning': 'status-warning',
                'checking': 'status-loading'
            }[status];
            
            text.textContent = {
                'connected': 'Connected',
                'error': 'Connection Failed',
                'warning': 'Limited Access',
                'checking': 'Checking...'
            }[status];
            
            detailsEl.textContent = details;
        }

        // Global functions
        window.checkEnvironment = async function() {
            log('🔧 Checking environment configuration...', 'system');
            updateConnectionStatus('checking', 'Diagnosing connection...');
            
            try {
                const diagnosis = await DatabaseService.diagnoseConnection();
                
                const envStatus = document.getElementById('env-status');
                envStatus.innerHTML = '';
                
                // Configuration status
                const configDiv = document.createElement('div');
                configDiv.className = `flex items-center text-sm ${diagnosis.configured ? 'text-green-600' : 'text-red-600'}`;
                configDiv.innerHTML = `
                    <span class="status-indicator ${diagnosis.configured ? 'status-success' : 'status-error'}"></span>
                    Configuration: ${diagnosis.configured ? 'Valid' : 'Missing environment variables'}
                `;
                envStatus.appendChild(configDiv);
                
                // Connection status
                const connDiv = document.createElement('div');
                connDiv.className = `flex items-center text-sm ${diagnosis.accessible ? 'text-green-600' : 'text-yellow-600'}`;
                connDiv.innerHTML = `
                    <span class="status-indicator ${diagnosis.accessible ? 'status-success' : 'status-warning'}"></span>
                    Database: ${diagnosis.accessible ? 'Accessible' : 'Configure credentials to test'}
                `;
                envStatus.appendChild(connDiv);
                
                // Tables status
                const tablesDiv = document.createElement('div');
                tablesDiv.innerHTML = `
                    <div class="text-sm font-medium text-gray-700 mt-2 mb-1">Database Status:</div>
                    <div class="text-xs text-gray-600 space-y-1">
                        ${diagnosis.tables.length > 0 ? diagnosis.tables.map(table => `
                            <div>• ${table}</div>
                        `).join('') : '<div class="text-orange-600">Configure .env file to test database access</div>'}
                    </div>
                `;
                envStatus.appendChild(tablesDiv);
                
                // Errors
                if (diagnosis.errors.length > 0) {
                    const errorsDiv = document.createElement('div');
                    errorsDiv.innerHTML = `
                        <div class="text-sm font-medium text-orange-700 mt-2 mb-1">Configuration Notes:</div>
                        <div class="text-xs text-orange-600 space-y-1">
                            ${diagnosis.errors.map(error => `<div>• ${error}</div>`).join('')}
                        </div>
                    `;
                    envStatus.appendChild(errorsDiv);
                }
                
                // Update overall connection status
                if (diagnosis.configured) {
                    updateConnectionStatus('connected', diagnosis.authenticated ? 'Authenticated access' : 'Ready for testing');
                    log('✅ Environment check completed - Ready for database testing', 'success');
                } else {
                    updateConnectionStatus('warning', 'Configure .env file to enable database testing');
                    log('⚠️ Configure VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY in .env file', 'warning');
                }
                
            } catch (error) {
                log(`❌ Environment check failed: ${error.message}`, 'error');
                updateConnectionStatus('error', error.message);
            }
        };

        window.signIn = async function() {
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            
            if (!email || !password) {
                log('❌ Please enter email and password', 'error');
                return;
            }
            
            log(`🔐 Signing in as ${email}...`, 'info');
            
            try {
                const result = await DatabaseService.signIn(email, password);
                
                if (result.success) {
                    currentUser = email;
                    log('✅ Sign in successful', 'success');
                    
                    // Recheck environment with authentication
                    setTimeout(checkEnvironment, 500);
                } else {
                    log(`❌ Sign in failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`❌ Sign in error: ${error.message}`, 'error');
            }
        };

        window.signUp = async function() {
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            
            if (!email || !password) {
                log('❌ Please enter email and password', 'error');
                return;
            }
            
            log(`👤 Creating test user ${email}...`, 'info');
            
            try {
                const result = await DatabaseService.signUp(email, password, {
                    fullName: 'Test User'
                });
                
                if (result.success) {
                    currentUser = email;
                    log('✅ Test user created and signed in successfully', 'success');
                    
                    // Recheck environment with authentication
                    setTimeout(checkEnvironment, 500);
                } else {
                    log(`❌ Sign up failed: ${result.error}`, 'error');
                    // If user already exists, try to sign in
                    if (result.error.includes('already') || result.error.includes('exist')) {
                        log('👤 User may already exist, trying to sign in...', 'info');
                        setTimeout(() => signIn(), 1000);
                    }
                }
            } catch (error) {
                log(`❌ Sign up error: ${error.message}`, 'error');
            }
        };

        window.signOut = async function() {
            log('🚪 Signing out...', 'info');
            
            try {
                const result = await DatabaseService.signOut();
                
                if (result.success) {
                    currentUser = null;
                    log('✅ Sign out successful', 'success');
                    
                    // Recheck environment without authentication
                    setTimeout(checkEnvironment, 500);
                } else {
                    log(`❌ Sign out failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`❌ Sign out error: ${error.message}`, 'error');
            }
        };

        window.updateAuthStatus = function(authenticated, userEmail = '') {
            const authStatus = document.getElementById('auth-status');
            const signinForm = document.getElementById('signin-form');
            const signoutForm = document.getElementById('signout-form');
            const currentUserEl = document.getElementById('current-user');
            
            if (authenticated) {
                authStatus.innerHTML = `
                    <div class="flex items-center text-sm text-green-600">
                        <span class="status-indicator status-success"></span>
                        Authenticated as ${userEmail}
                    </div>
                `;
                signinForm.style.display = 'none';
                signoutForm.style.display = 'block';
                if (currentUserEl) currentUserEl.textContent = userEmail;
            } else {
                authStatus.innerHTML = `
                    <div class="flex items-center text-sm text-gray-600">
                        <span class="status-indicator status-error"></span>
                        Not authenticated
                    </div>
                `;
                signinForm.style.display = 'block';
                signoutForm.style.display = 'none';
            }
        };

        window.testRLSPolicies = async function() {
            log('🛡️ Testing RLS policies...', 'info');
            
            try {
                const results = await DatabaseService.testRLSPolicies();
                const rlsResults = document.getElementById('rls-results');
                rlsResults.innerHTML = '';
                
                // Overall status
                const statusDiv = document.createElement('div');
                statusDiv.className = `flex items-center text-sm mb-3 ${results.authenticated ? 'text-green-600' : 'text-yellow-600'}`;
                statusDiv.innerHTML = `
                    <span class="status-indicator ${results.authenticated ? 'status-success' : 'status-warning'}"></span>
                    ${results.authenticated ? 'Authenticated - Testing full CRUD operations' : 'Unauthenticated - Testing public access only'}
                `;
                rlsResults.appendChild(statusDiv);
                
                // Table results
                Object.entries(results.tables).forEach(([tableName, tableResult]) => {
                    const tableDiv = document.createElement('div');
                    tableDiv.className = 'border border-gray-200 rounded p-3 mb-2';
                    
                    const permissions = [
                        { name: 'Read', allowed: tableResult.canRead, icon: '👁️' },
                        { name: 'Insert', allowed: tableResult.canInsert, icon: '➕' },
                        { name: 'Update', allowed: tableResult.canUpdate, icon: '✏️' },
                        { name: 'Delete', allowed: tableResult.canDelete, icon: '🗑️' }
                    ];
                    
                    tableDiv.innerHTML = `
                        <div class="font-medium text-gray-900 mb-2">📋 ${tableName}</div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            ${permissions.map(perm => `
                                <div class="flex items-center text-xs ${perm.allowed ? 'text-green-600' : 'text-red-600'}">
                                    <span class="status-indicator ${perm.allowed ? 'status-success' : 'status-error'}"></span>
                                    ${perm.icon} ${perm.name}
                                </div>
                            `).join('')}
                        </div>
                        ${tableResult.errors.length > 0 ? `
                            <div class="text-xs text-red-600 mt-1">
                                ${tableResult.errors.map(error => `<div>• ${error}</div>`).join('')}
                            </div>
                        ` : ''}
                    `;
                    
                    rlsResults.appendChild(tableDiv);
                });
                
                log('✅ RLS policy testing completed', 'success');
                
            } catch (error) {
                log(`❌ RLS testing failed: ${error.message}`, 'error');
            }
        };

        window.testDatabaseOperations = async function(table) {
            log(`🗄️ Testing ${table} operations...`, 'info');
            
            if (!DatabaseService.currentUser) {
                log(`❌ Authentication required to test ${table} operations`, 'error');
                return;
            }
            
            try {
                const timestamp = Date.now();
                let testItem;
                
                // Create test data based on table
                switch (table) {
                    case 'prep_lists':
                        testItem = {
                            id: `test-${timestamp}`,
                            name: `Test Prep List ${new Date().toLocaleTimeString()}`,
                            items: [{ id: '1', name: 'Test Item', quantity: '5', unit: 'lbs' }]
                        };
                        break;
                    case 'events':
                        testItem = {
                            id: `test-${timestamp}`,
                            title: `Test Event ${new Date().toLocaleTimeString()}`,
                            event_date: new Date().toISOString().split('T')[0],
                            status: 'pending',
                            total_servings: 25
                        };
                        break;
                    case 'recipes':
                        testItem = {
                            id: `test-${timestamp}`,
                            name: `Test Recipe ${new Date().toLocaleTimeString()}`,
                            ingredients: ['Test ingredient'],
                            instructions: 'Test instructions'
                        };
                        break;
                    case 'methods':
                        testItem = {
                            id: `test-${timestamp}`,
                            name: `Test Method ${new Date().toLocaleTimeString()}`,
                            description: 'Test cooking method'
                        };
                        break;
                    default:
                        throw new Error(`Unknown table: ${table}`);
                }

                // Insert test item
                const { data, error } = await DatabaseService.supabase
                    .from(table)
                    .insert(testItem)
                    .select()
                    .single();

                if (error) throw error;
                
                log(`✅ Created ${table} item: ${data.name || data.title}`, 'success');
                
                // Load items to verify
                const { data: items, error: loadError } = await DatabaseService.supabase
                    .from(table)
                    .select('id, name, title')
                    .limit(5);

                if (loadError) throw loadError;
                
                log(`✅ Loaded ${items.length} ${table} items`, 'success');
                
            } catch (error) {
                log(`❌ ${table} operations test failed: ${error.message}`, 'error');
            }
        };

        window.createTestData = async function() {
            log('➕ Creating comprehensive test data...', 'info');
            
            try {
                await DatabaseService.createTestData();
                log('✅ Test data created successfully', 'success');
            } catch (error) {
                log(`❌ Test data creation failed: ${error.message}`, 'error');
            }
        };

        window.cleanupTestData = async function() {
            log('🗑️ Cleaning up test data...', 'info');
            
            try {
                const result = await DatabaseService.cleanupTestData();
                log(`✅ Test data cleanup completed - removed ${result.deleted} items`, 'success');
            } catch (error) {
                log(`❌ Test data cleanup failed: ${error.message}`, 'error');
            }
        };

        window.testRealtime = async function() {
            log('⚡ Testing real-time connections...', 'info');
            
            const realtimeStatus = document.getElementById('realtime-status');
            realtimeStatus.innerHTML = `
                <span class="status-indicator status-loading"></span>
                Testing real-time subscriptions...
            `;
            
            try {
                // Test real-time subscription
                const channel = DatabaseService.supabase
                    .channel('test-channel')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'prep_lists'
                    }, (payload) => {
                        log(`📡 Real-time event received: ${payload.eventType} on prep_lists`, 'info');
                    })
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            realtimeStatus.innerHTML = `
                                <span class="status-indicator status-success"></span>
                                Real-time subscriptions active
                            `;
                            log('✅ Real-time testing completed - subscriptions working', 'success');
                        } else if (status === 'CHANNEL_ERROR') {
                            realtimeStatus.innerHTML = `
                                <span class="status-indicator status-error"></span>
                                Real-time connection failed
                            `;
                            log('❌ Real-time subscription failed', 'error');
                        }
                    });

                // Cleanup after 5 seconds
                setTimeout(() => {
                    channel.unsubscribe();
                    log('📡 Real-time test channel closed', 'info');
                }, 5000);
                
            } catch (error) {
                realtimeStatus.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    Real-time test failed
                `;
                log(`❌ Real-time testing failed: ${error.message}`, 'error');
            }
        };

        window.runPerformanceTests = async function() {
            log('🏃‍♂️ Running performance tests...', 'info');
            
            const performanceResults = document.getElementById('performance-results');
            performanceResults.innerHTML = '<div class="text-sm text-gray-600">Running tests...</div>';
            
            try {
                const tests = [
                    { name: 'SELECT prep_lists', query: () => DatabaseService.supabase.from('prep_lists').select('id').limit(1) },
                    { name: 'SELECT events', query: () => DatabaseService.supabase.from('events').select('id').limit(1) },
                    { name: 'SELECT recipes', query: () => DatabaseService.supabase.from('recipes').select('id').limit(1) },
                    { name: 'Auth session check', query: () => DatabaseService.supabase.auth.getSession() }
                ];

                const results = [];
                
                for (const test of tests) {
                    const start = performance.now();
                    try {
                        await test.query();
                        const time = Math.round(performance.now() - start);
                        results.push({ operation: test.name, time: `${time}ms`, success: true });
                        log(`⚡ ${test.name}: ${time}ms`, 'success');
                    } catch (error) {
                        const time = Math.round(performance.now() - start);
                        results.push({ operation: test.name, time: `${time}ms (failed)`, success: false });
                        log(`❌ ${test.name}: ${error.message}`, 'error');
                    }
                }
                
                performanceResults.innerHTML = results.map(result => `
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-700">${result.operation}:</span>
                        <span class="${result.success ? 'text-green-600' : 'text-red-600'} font-medium">${result.time}</span>
                    </div>
                `).join('');
                
                log('✅ Performance tests completed', 'success');
                
            } catch (error) {
                log(`❌ Performance testing failed: ${error.message}`, 'error');
            }
        };

        window.clearConsole = function() {
            document.getElementById('console-log').innerHTML = '';
            log('🧹 Console cleared', 'system');
        };

        window.exportLog = function() {
            const logContent = document.getElementById('console-log').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prep-chef-db-test-${new Date().toISOString().slice(0,19)}.log`;
            a.click();
            URL.revokeObjectURL(url);
            log('📄 Test log exported', 'info');
        };

        // Initialize on load
        window.addEventListener('load', async () => {
            log('🚀 Database testing interface loaded', 'system');
            
            try {
                await DatabaseService.initialize();
                log('✅ Database service initialized', 'system');
                
                // Check environment automatically
                setTimeout(checkEnvironment, 1000);
                
            } catch (error) {
                log(`❌ Database service initialization failed: ${error.message}`, 'error');
                updateConnectionStatus('error', error.message);
            }
        });
    </script>
</body>
</html>